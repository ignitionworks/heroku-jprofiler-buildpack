#!/bin/bash
# Exit if command fails
set -e
# Exit on unset variables
set -u

build_dir="$1"; shift
cache_dir="$1"; shift
env_dir="$1"; shift

jprofiler_archive_filename="jprofiler_linux_12_0.tar.gz"
jprofiler_archive_sha256_sum="26db0bed385b42cbdb1423c4261679c7a37f6da7fc0e29616fc01c6f1f86f732"
jprofiler_archive_url="https://download-gcdn.ej-technologies.com/jprofiler/$jprofiler_archive_filename"
jprofiler_archive_download_dir="$cache_dir"
jprofiler_archive_download_path="$jprofiler_archive_download_dir/$jprofiler_archive_filename"

jprofiler_archive_agent_library_path="jprofiler12.0/bin/linux-x64/libjprofilerti.so"
jprofiler_archive_agent_library_path_components=3

jprofiler_archive_agent_jar_path="bin/agent.jar"
jprofiler_archive_agent_jar_path_components=1

sha256sum_bin="/usr/bin/sha256sum"

# Generate expected checksum digest
echo "$jprofiler_archive_sha256_sum  $jprofiler_archive_download_path" > checksum.sha

# Check shasum256 installed
$sha256sum_bin --version > /dev/null

# Check cache
echo "Checking cache for valid download"
set +e
$sha256sum_bin --check checksum.sha
exit_value="$?"
set -e

if [ $exit_value -ne 0 ]
then
  echo "Downloading jprofiler from '$jprofiler_archive_url' to '$jprofiler_archive_download_path'"
  wget --quiet \
       --directory-prefix "$jprofiler_archive_download_dir" \
       "$jprofiler_archive_url"
  $sha256sum_bin --check checksum.sha
else
  echo "Cached archive '$jprofiler_archive_download_path' has correct checksum, skipping download"
fi

echo "Extracting JProfiler's profiling agent to application"
tar --extract \
    --file="$jprofiler_archive_download_path" \
    --directory "$build_dir" \
    --strip-components $jprofiler_archive_agent_library_path_components \
    "$jprofiler_archive_agent_library_path"

tar --extract \
    --file="$jprofiler_archive_download_path" \
    --directory "$build_dir" \
    --strip-components $jprofiler_archive_agent_jar_path_components \
    "$jprofiler_archive_agent_jar_path"
